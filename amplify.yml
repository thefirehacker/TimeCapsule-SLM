version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ“¦ Installing Git LFS..."
        - sudo yum install -y git-lfs
        - git lfs install
        - git lfs pull
        - echo "ğŸ“¦ Installing dependencies..."
        - npm ci --cache .npm --prefer-offline
        - echo "ğŸ”§ Node.js version:"
        - node --version
        - echo "ğŸ“¦ npm version:"
        - npm --version
        - echo "ğŸŒ Environment variables check..."
        - echo "NEXT_PUBLIC_GA4_MEASUREMENT_ID is ${NEXT_PUBLIC_GA4_MEASUREMENT_ID:-'not set'}"
        - echo "NEXT_PUBLIC_SITE_NAME is ${NEXT_PUBLIC_SITE_NAME:-'not set'}"
        - echo "NEXT_PUBLIC_SITE_URL is ${NEXT_PUBLIC_SITE_URL:-'not set'}"
        - echo "GA4_ANONYMIZE_IP is ${GA4_ANONYMIZE_IP:-'not set'}"
        - echo "GA4_DEBUG_MODE is ${GA4_DEBUG_MODE:-'not set'}"
        - echo "ğŸ” Authentication variables check..."
        - echo "AUTH_SECRET is ${AUTH_SECRET:+set}"
        - echo "AUTH_GITHUB_ID is ${AUTH_GITHUB_ID:+set}"
        - echo "AUTH_GITHUB_SECRET is ${AUTH_GITHUB_SECRET:+set}"
        - echo "AUTH_GOOGLE_ID is ${AUTH_GOOGLE_ID:+set}"
        - echo "AUTH_GOOGLE_SECRET is ${AUTH_GOOGLE_SECRET:+set}"
        - echo "NEXTAUTH_URL is ${NEXTAUTH_URL:+set}"
        - echo "ğŸ—„ï¸ Database variables check..."
        - echo "AWS_REGION is ${REGION_AWS:+set}"
        - echo "AWS_ACCESS_KEY_ID is ${ACCESS_KEY_ID_AWS:+set}"
        - echo "AWS_SECRET_ACCESS_KEY is ${SECRET_ACCESS_KEY_AWS:+set}"
        - |
            if [ "$NEXT_BUILD_ENV" = "cloud" ]; then
              echo "S3_BUCKET is ${S3_BUCKET:+set}"
              echo "OPEN_ROUTER_API_KEY is ${OPEN_ROUTER_API_KEY:+set}"
            else
              echo "Skipping cloud-only env vars (S3_BUCKET/OPEN_ROUTER_API_KEY)"
            fi
        - echo "ğŸ“§ Email service variables check..."
        - echo "RESEND_API_KEY is ${RESEND_API_KEY:+set}"
        - echo "ğŸ’° Payment service variables check..."
        - echo "NEXT_PUBLIC_RAZORPAY_KEY_ID is ${NEXT_PUBLIC_RAZORPAY_KEY_ID:+set}"
        - echo "RAZORPAY_KEY_ID is ${RAZORPAY_KEY_ID:+set}"
        - echo "RAZORPAY_KEY_SECRET is ${RAZORPAY_KEY_SECRET:+set}"
        - echo "RAZORPAY_WEBHOOK_SECRET is ${RAZORPAY_WEBHOOK_SECRET:+set}"
        - echo "NEXT_PUBLIC_FIRECRAWL_API_KEY is ${NEXT_PUBLIC_FIRECRAWL_API_KEY:+set}"
    build:
      commands:
        - echo "ğŸ”¨ Building Next.js application..."
        - echo "ğŸ” Creating .env.production for runtime environment variables..."
        - echo "# Runtime environment variables for NextAuth" > .env.production
        - echo "AUTH_SECRET=$AUTH_SECRET" >> .env.production
        - echo "AUTH_GOOGLE_ID=$AUTH_GOOGLE_ID" >> .env.production
        - echo "AUTH_GOOGLE_SECRET=$AUTH_GOOGLE_SECRET" >> .env.production
        - echo "AUTH_GITHUB_ID=$AUTH_GITHUB_ID" >> .env.production
        - echo "AUTH_GITHUB_SECRET=$AUTH_GITHUB_SECRET" >> .env.production
        - echo "NEXTAUTH_SECRET=$AUTH_SECRET" >> .env.production
        - echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env.production
        - echo "NODE_ENV=production" >> .env.production
        - echo "AWS_REGION=$REGION_AWS" >> .env.production
        - echo "AWS_ACCESS_KEY_ID=$ACCESS_KEY_ID_AWS" >> .env.production
        - echo "AWS_SECRET_ACCESS_KEY=$SECRET_ACCESS_KEY_AWS" >> .env.production
        - echo "RESEND_API_KEY=$RESEND_API_KEY" >> .env.production
        - echo "NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL" >> .env.production
        - echo "NEXT_PUBLIC_RAZORPAY_KEY_ID=$NEXT_PUBLIC_RAZORPAY_KEY_ID" >> .env.production
        - echo "RAZORPAY_KEY_ID=$RAZORPAY_KEY_ID" >> .env.production
        - echo "RAZORPAY_KEY_SECRET=$RAZORPAY_KEY_SECRET" >> .env.production
        - echo "RAZORPAY_WEBHOOK_SECRET=$RAZORPAY_WEBHOOK_SECRET" >> .env.production
        - echo "NEXT_PUBLIC_FIRECRAWL_API_KEY=%NEXT_PUBLIC_FIRECRAWL_API_KEY" >> .env.production
        - echo "NEXT_BUILD_ENV=$NEXT_BUILD_ENV" >> .env.production
        - |
            if [ "$NEXT_BUILD_ENV" = "cloud" ]; then
              echo "S3_BUCKET=$S3_BUCKET" >> .env.production
              echo "OPEN_ROUTER_API_KEY=$OPEN_ROUTER_API_KEY" >> .env.production
            else
              echo "Skipping cloud-only env exports (S3_BUCKET/OPEN_ROUTER_API_KEY)"
            fi
        - echo "âœ… Environment variables written to .env.production"
        - echo "ğŸ” Verifying .env.production contents:"
        - cat .env.production
        - echo "ğŸ” === Checking ONNX model files ==="
        - ls -lh public/embeddings/ || echo "âŒ public/embeddings/ not found"
        - ls -lh public/embeddings/onnx/ || echo "âŒ public/embeddings/onnx/ not found"
        - file public/embeddings/onnx/model.onnx || echo "âŒ model.onnx not found"
        - file public/embeddings/onnx/model_quantized.onnx || echo "â„¹ï¸ model_quantized.onnx not found (may be optional)"
        - echo "ğŸ“„ First line of model.onnx:"
        - head -n 1 public/embeddings/onnx/model.onnx || echo "âŒ Can't read model.onnx"
        - echo "ğŸ” === Checking WASM files ==="
        - ls -lh public/onnxruntime-web/ || echo "âŒ public/onnxruntime-web/ not found"
        - file public/onnxruntime-web/ort-wasm-simd.wasm || echo "âŒ ort-wasm-simd.wasm not found"
        - echo "ğŸ“„ First 4 bytes of ort-wasm-simd.wasm (should be 00 61 73 6d):"
        - xxd -l 4 public/onnxruntime-web/ort-wasm-simd.wasm || echo "âŒ Can't read WASM file"
        - echo "ğŸ” === Checking node_modules fallback ==="
        - ls -lh node_modules/onnxruntime-web/dist/ || echo "âŒ node_modules/onnxruntime-web/dist/ not found"
        - file node_modules/onnxruntime-web/dist/ort-wasm-simd.wasm || echo "âŒ fallback WASM not found"
        - echo "âœ… === Diagnostics complete, starting build ==="
        - echo "ğŸ—ï¸ Starting Next.js build..."
        - npm run build
        - echo "ğŸ§¹ Cleaning up large files to reduce build output size..."
        - echo "ğŸ—‘ï¸ Removing .next/cache (build cache - not needed for deployment)..."
        - rm -rf .next/cache
        - echo "â„¹ï¸ Model cleanup done in repo (only onnx/model.onnx kept, 64MB FP16)"
        - echo "ğŸ—‘ï¸ Removing public WASM files (already bundled in .next)..."
        - rm -rf public/onnxruntime-web/*.wasm
        - echo "ğŸ—‘ï¸ Removing unnecessary SWC binaries..."
        - rm -rf node_modules/@swc/core-linux-x64-gnu || true
        - rm -rf node_modules/@swc/core-linux-x64-musl || true
        - echo "â„¹ï¸ Keeping onnxruntime-node (required by Xenova transformers)"
        # - rm -rf node_modules/onnxruntime-node || true  # Commented out - Xenova needs this
        - echo "ğŸ“Š Build output sizes after cleanup:"
        - du -sh .next public node_modules
        - echo "ğŸ“Š Total deployment size (should be under 220MB):"
        - du -ch .next public node_modules | grep total
        - echo "âœ… Build completed successfully!"
    postBuild:
      commands:
        - echo "ğŸ“Š Post-build optimizations..."
        - echo "ğŸ” Moving .env.production into .next for deployment..."
        - cp .env.production .next/.env.production
        - echo "ğŸ” Checking build output..."
        - ls -la .next/
        - echo "ğŸ” Verifying .env.production exists in build output:"
        - ls -la .next/.env.production || echo "âš ï¸ .env.production not found"
        - echo "âœ… Build artifacts created successfully"
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
    exclude:
      - "cache/**/*"
      - "node_modules/**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .npm/**/*
  customHeaders:
    - pattern: "**/*"
      headers:
        - key: "X-Frame-Options"
          value: "DENY"
        - key: "X-XSS-Protection"
          value: "1; mode=block"
        - key: "X-Content-Type-Options"
          value: "nosniff"
        - key: "Referrer-Policy"
          value: "strict-origin-when-cross-origin"
        - key: "Permissions-Policy"
          value: "camera=(), microphone=(), geolocation=()"
    - pattern: "/favicon.ico"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=86400"
    - pattern: "/Media/**/*"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"
    - pattern: "/_next/static/**/*"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"

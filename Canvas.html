<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SketchPad-SLM - Live p5.js Editor</title>
  <link rel="icon" type="image/png" href="lib/Media/SketchPad-SLM.png">
  <link rel="shortcut icon" type="image/png" href="lib/Media/SketchPad-SLM.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh; 
      overflow: hidden;
    }
    
    .container {
      display: grid;
      grid-template-columns: 250px 1fr 2fr;
      grid-template-rows: 120px 1fr;
      height: 100vh;
      gap: 10px;
      padding: 10px;
      position: relative;
    }
    
    .header {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      background: linear-gradient(45deg, #fff, #f0f8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .controls-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      overflow-y: auto;
    }
    
    .controls-panel h3 {
      margin-bottom: 20px;
      font-size: 18px;
      color: #fff;
      text-align: center;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .btn {
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.primary {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .btn.primary:hover {
      box-shadow: 0 8px 25px rgba(250, 112, 154, 0.6);
    }
    
    .btn.secondary {
      background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
      box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);
    }
    
    select, input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    select option {
      background: #333;
      color: white;
    }
    
    .editor-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .editor-container.expanded {
      grid-column: 2 / -1;
      z-index: 100;
    }
    
    .editor-container.minimized {
      height: 60px;
      overflow: hidden;
    }
    
    .editor-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .editor-controls {
      display: flex;
      gap: 8px;
    }
    
    .editor-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s ease;
      min-width: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .editor-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }
    
    #editor { 
      flex: 1;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .canvas-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .canvas-container.hidden {
      display: none;
    }
    
    .canvas-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }
    
    #canvas { 
      flex: 1;
      background: #111; 
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .status-bar {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .hidden {
      display: none;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Logo hover effect */
    .header img:hover {
      transform: scale(1.05) rotate(2deg);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5)) brightness(1.2);
      border-color: rgba(255,255,255,0.5);
    }
    
    /* Floating AI Panel (Cursor-style) */
    .ai-floating-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .ai-floating-panel.minimized {
      height: 60px;
      width: 300px;
    }
    
    .ai-floating-panel.hidden {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    /* AI Toggle Button (always visible) */
    .ai-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
      transition: all 0.3s ease;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
    }
    
    .ai-toggle-btn.active {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 20px rgba(250, 112, 154, 0.4);
    }
    
    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      color: white;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ai-panel-controls {
      display: flex;
      gap: 8px;
    }
    
    .panel-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .panel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .ai-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
    }
    
    .ai-content.minimized {
      display: none;
    }
    
    .chat-history {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      min-height: 150px;
    }
    
    .ai-input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .ai-prompt-input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }
    
    .ai-prompt-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-actions {
      display: flex;
      gap: 8px;
    }
    
    .ai-btn {
      flex: 1;
      padding: 10px 16px;
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .ai-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-btn.secondary {
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .chat-message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .chat-message.user {
      background: rgba(79, 172, 254, 0.2);
      color: #e6f3ff;
      margin-left: 20px;
    }
    
    .chat-message.ai {
      background: rgba(250, 112, 154, 0.2);
      color: #ffe6f0;
      margin-right: 20px;
    }
    
    .chat-message.system {
      background: rgba(168, 237, 234, 0.2);
      color: #e6fffe;
      font-style: italic;
      text-align: center;
    }
    
    .message-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .code-preview {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 8px;
      border-left: 3px solid #4facfe;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 25px;">
        <img src="lib/Media/SketchPad-SLM.png" alt="SketchPad-SLM" style="width: 160px; height: 160px; object-fit: contain; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5)) brightness(1.1); border-radius: 16px; background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)); padding: 16px; border: 3px solid rgba(255,255,255,0.3); transition: all 0.3s ease;">
        <div style="display: flex; flex-direction: column;">
          <h1 style="margin: 0; font-size: 28px; font-weight: 700;">SketchPad-SLM</h1>
          <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 2px;">Creative Coding Studio</div>
        </div>
      </div>
      <div style="margin-left: auto; color: rgba(255,255,255,0.8); font-size: 16px; font-weight: 500;">
        ü§ñ AI Integration
      </div>
    </div>
    
    <div class="controls-panel">
      <h3>üéÆ Controls</h3>
      
      <div class="control-group">
        <button id="runBtn" class="btn primary">‚ñ∂Ô∏è Draw</button>
      </div>
      
      <div class="control-group">
        <label>üìÅ Load Design:</label>
        <select id="designSelect">
          <option value="">Choose a design...</option>
          <option value="fish">üêü Fish Animation</option>
          <option value="rabbit">üê∞ Rabbit Bounce</option>
          <option value="spiral">üåÄ Rainbow Spiral</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>üìÇ File Operations:</label>
        <input type="file" id="fileInput" accept=".js" class="hidden">
        <button id="loadFileBtn" class="btn secondary">üìÅ Load JS File</button>
        <button id="saveFileBtn" class="btn secondary">üíæ Save JS File</button>
      </div>
      

      
      <div class="control-group">
        <label>üéØ Quick Actions:</label>
        <button id="clearBtn" class="btn">üóëÔ∏è Clear Canvas</button>
        <button id="resetBtn" class="btn">üîÑ Reset Code</button>
      </div>
      
      <div class="status-bar" id="statusBar">
        Ready to create amazing p5.js art! üöÄ
      </div>
    </div>
    
    <div class="editor-container" id="editorContainer">
      <div class="editor-header">
        <span>üìù Code Editor</span>
        <div class="editor-controls">
          <button class="editor-btn" id="minimizeEditorBtn" title="Minimize Editor">‚àí</button>
          <button class="editor-btn" id="expandEditorBtn" title="Expand Editor">‚§¢</button>
        </div>
      </div>
      <div id="editor"></div>
    </div>
    
    <div class="canvas-container">
      <div class="canvas-header">üñºÔ∏è Canvas Output</div>
      <div id="canvas"></div>
    </div>
  </div>

  <!-- Floating AI Toggle Button -->
  <button class="ai-toggle-btn" id="aiToggleBtn">ü§ñ</button>

  <!-- Floating AI Panel -->
  <div class="ai-floating-panel hidden" id="aiFloatingPanel">
    <div class="ai-panel-header">
      <span>ü§ñ AI Assistant</span>
      <div class="ai-panel-controls">
        <button class="panel-btn" id="minimizeBtn">‚àí</button>
        <button class="panel-btn" id="closeBtn">√ó</button>
      </div>
    </div>
    
    <div class="ai-content" id="aiContent">
      <div class="ai-status-bar">
        <div id="aiStatus">AI: Not connected</div>
        <div style="display: flex; gap: 5px;">
          <button id="chatModeBtn" class="panel-btn">üé® Creative Mode</button>
          <button id="initAIBtn" class="panel-btn">üîå Connect</button>
        </div>
      </div>
      
      <div class="chat-history" id="chatHistory">
        <div class="chat-message system">
          <div class="message-header">‚öôÔ∏è System</div>
          Welcome to AI-powered creative coding! Connect AI and start chatting to generate amazing p5.js art.
        </div>
      </div>
      
      <div class="ai-input-section">
        <textarea 
          id="aiPrompt" 
          class="ai-prompt-input"
          placeholder="Describe what you want to create... e.g., 'colorful spinning triangles' or 'particle system with gravity'"
        ></textarea>
        <div class="ai-actions">
          <button id="generateBtn" class="ai-btn" disabled>‚ú® Generate Code</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs/loader.js"></script>

  <script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs' } });

    let editorInstance, currentP5, aiSession = null;
    let chatHistory = [];
    let chatMode = 'creative'; // 'creative' or 'general'
    
    // Design files mapping
    const designs = {
      fish: 'lib/Designs/fish.js',
      rabbit: 'lib/Designs/rabbit.js',
      spiral: 'lib/Designs/spiral.js'
    };

    // AI System Prompt - Teaches Gemini Nano about SketchPad-SLM
    const SYSTEM_PROMPT = `You are an AI assistant for SketchPad-SLM, a creative coding studio that uses p5.js with compact JavaScript syntax.

IMPORTANT RULES:
1. Always generate COMPACT p5.js code that works in our editor
2. Use the specific syntax patterns shown below
3. Keep code concise and creative
4. Focus on visual/generative art patterns

REQUIRED CODE STRUCTURE:
- Use compact syntax: t=0,draw=_=>{...}
- Always include: t||createCanvas(w,h) for setup
- Use global variables: t (time), w/h (dimensions)
- Animation: increment t each frame
- Drawing: use p5.js functions like point(), ellipse(), stroke(), fill()

EXAMPLES OF GOOD CODE:
1. Simple animation:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0)
  t+=0.05
  fill(sin(t)*127+128,cos(t)*127+128,255)
  ellipse(w/2+sin(t)*100,h/2+cos(t)*100,50,50)
}

2. Particle system:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.02
  for(i=0;i<100;i++){
    x=w/2+sin(t+i)*i*2
    y=h/2+cos(t+i*0.1)*i*2
    fill(i*2,255-i*2,255)
    ellipse(x,y,5,5)
  }
}

AVAILABLE FUNCTIONS:
- Drawing: point(), line(), ellipse(), rect(), arc(), triangle()
- Color: fill(), stroke(), noFill(), noStroke(), background()
- Math: sin(), cos(), noise(), random(), mag(), PI, TWO_PI
- Canvas: createCanvas(), strokeWeight()

When user asks for something, generate creative, compact p5.js code that creates visual art matching their request.`;

    // Initialize AI with Multiple Options
    async function initializeAI() {
      try {
        updateStatus('ü§ñ Initializing AI system...');
        document.getElementById('aiStatus').textContent = 'AI: Checking...';
        
        // Show AI selection modal
        showAISelectionModal();
        
      } catch (error) {
        console.error('AI initialization error:', error);
        fallbackToTemplates();
      }
    }

    // Show AI selection modal
    function showAISelectionModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 2000; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
          <h2 style="color: white; margin-bottom: 20px; text-align: center;">ü§ñ Choose AI Engine</h2>
          
          <div style="margin-bottom: 20px;">
            <button id="selectJanus" class="ai-option-btn">
              üöÄ Qwen2.5-0.5B (Local) - AI Powered
            </button>
            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
              Downloads ~500MB model, runs in browser. Auto-fallback to templates if WebGPU issues occur.
            </p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <button id="selectTemplates" class="ai-option-btn">
              ‚ö° Smart Templates - Instant & Reliable
            </button>
            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
              Pattern-based code generation, always works
            </p>
          </div>
          
          <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                  color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                  float: right; margin-top: 10px;">Cancel</button>
        </div>
      `;
      
      const style = document.createElement('style');
      style.textContent = `
        .ai-option-btn {
          width: 100%; padding: 15px; margin: 5px 0; background: rgba(255,255,255,0.1);
          border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white;
          font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .ai-option-btn:hover {
          background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5);
          transform: translateY(-2px);
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Event listeners
      document.getElementById('selectJanus').onclick = () => {
        document.body.removeChild(modal);
        initializeJanus();
      };
      
      document.getElementById('selectTemplates').onclick = () => {
        document.body.removeChild(modal);
        fallbackToTemplates();
      };
      
      document.getElementById('closeModal').onclick = () => {
        document.body.removeChild(modal);
        fallbackToTemplates();
      };
    }



    // Initialize Qwen2.5
    async function initializeJanus() {
      try {
        updateStatus('üöÄ Loading Qwen2.5-0.5B (~500MB)...');
        document.getElementById('aiStatus').textContent = 'AI: Loading Qwen2.5...';
        
        // Check browser compatibility
        const hasFloat16 = typeof Float16Array !== 'undefined';
        if (!hasFloat16) {
          addChatMessage('system', '‚ö†Ô∏è Your browser lacks Float16Array support. Using q4 quantization instead of q4f16 for better compatibility.');
        }
        
        // Show loading screen
        showLoadingScreen();
        
        // Import Transformers.js
        updateLoadingProgress(10, 'Importing Transformers.js...');
        
        // Temporarily suppress verbose ONNX warnings during loading
        const originalWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          if (message.includes('VerifyEachNodeIsAssignedToAnEp') || 
              message.includes('Some nodes were not assigned') ||
              message.includes('Rerunning with verbose output')) {
            return; // Suppress these specific warnings
          }
          originalWarn.apply(console, args);
        };
        
        const { AutoTokenizer, AutoModelForCausalLM } = await import('https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.1.0');
        
        const MODEL = 'onnx-community/Qwen2.5-0.5B-Instruct-ONNX';
        
        // Load tokenizer first
        updateLoadingProgress(20, 'Loading tokenizer...');
        const tokenizer = await AutoTokenizer.from_pretrained(MODEL, {
          progress_callback: (progress) => {
            try {
              if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                const percent = 20 + (progress.progress * 30);
                const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                updateLoadingProgress(percent, `Loading tokenizer: ${fileName}`);
              }
            } catch (e) {
              console.warn('Progress callback error:', e);
            }
          }
        });
        
        // WebGPU-only loading with timeout handling
        let model;
        
        // Timeout wrapper function
        const loadWithTimeout = async (loadFn, timeoutMs, description) => {
          return Promise.race([
            loadFn(),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`${description} timed out after ${timeoutMs/1000}s`)), timeoutMs)
            )
          ]);
        };
        
                  try {
            updateLoadingProgress(50, 'Loading with WebGPU acceleration...');
            addChatMessage('system', 'üöÄ Starting WebGPU model download (~500MB). Using text-only mode to avoid vision model errors. This may take 2-5 minutes...');
          
          // Add progress timeout detection
          let lastProgress = 0;
          let progressStuckTime = Date.now();
          
          model = await loadWithTimeout(
            () => AutoModelForCausalLM.from_pretrained(MODEL, {
              device: 'webgpu',
              dtype: 'q4',
              progress_callback: (progress) => {
                try {
                  if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                    const percent = 50 + (progress.progress * 40);
                    const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                    updateLoadingProgress(percent, `Loading model (WebGPU): ${fileName}`);
                    
                    // Detect stuck progress
                    if (Math.abs(progress.progress - lastProgress) > 0.01) {
                      lastProgress = progress.progress;
                      progressStuckTime = Date.now();
                    } else if (Date.now() - progressStuckTime > 60000) {
                      // Progress stuck for 60 seconds
                      throw new Error('Download progress stuck - likely network or memory issue');
                    }
                  }
                } catch (e) {
                  console.warn('Progress callback error:', e);
                }
              }
            }),
            300000, // 5 minute timeout
            'WebGPU model loading'
          );
          
          addChatMessage('system', 'üöÄ WebGPU acceleration enabled! GPU-only mode active.');
        } catch (webgpuError) {
          console.warn('WebGPU loading failed:', webgpuError);
          
          // Check if it's a timeout or memory issue
          if (webgpuError.message.includes('timed out') || webgpuError.message.includes('stuck')) {
            addChatMessage('system', '‚ö†Ô∏è Large model download timed out. This is common with 500MB models. Falling back to templates...');
            hideLoadingScreen();
            fallbackToTemplates();
            return;
          }
          
          // Only one fallback: basic WebGPU without device specification
          try {
            updateLoadingProgress(70, 'WebGPU failed, trying basic GPU mode...');
            addChatMessage('system', '‚ö†Ô∏è WebGPU failed, trying basic GPU configuration...');
            
            model = await loadWithTimeout(
              () => AutoModelForCausalLM.from_pretrained(MODEL, {
                dtype: 'q4',
                progress_callback: (progress) => {
                  try {
                    if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                      const percent = 70 + (progress.progress * 25);
                      const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                      updateLoadingProgress(percent, `Loading model (basic): ${fileName}`);
                    }
                  } catch (e) {
                    console.warn('Progress callback error:', e);
                  }
                }
              }),
              180000, // 3 minute timeout for fallback
              'Basic GPU model loading'
            );
            
            addChatMessage('system', '‚úÖ Basic GPU mode successful! Model loaded.');
          } catch (finalError) {
            console.error('All GPU loading attempts failed:', finalError);
            
            // If both attempts failed, fall back to templates
            addChatMessage('system', '‚ùå GPU model loading failed completely. Using smart templates instead.');
            hideLoadingScreen();
            fallbackToTemplates();
            return;
          }
        }
        
        updateLoadingProgress(95, 'Finalizing model setup...');
        aiSession = { type: 'qwen', model, tokenizer };
        document.getElementById('aiStatus').textContent = 'AI: Qwen2.5-0.5B ‚úÖ';
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = 'üöÄ Qwen2.5 Ready';
        
        // Restore console.warn
        console.warn = originalWarn;
        
        updateLoadingProgress(100, 'Model loaded successfully!');
        setTimeout(() => {
          hideLoadingScreen();
          updateStatus('üöÄ Qwen2.5-0.5B loaded successfully!');
          addChatMessage('system', 'üöÄ Qwen2.5-0.5B loaded! Ready to generate creative p5.js code. This text-only model avoids all vision-related errors.');
        }, 500);
        
      } catch (error) {
        console.error('Janus initialization error:', error);
        
        // Restore console.warn in case of error
        if (typeof originalWarn !== 'undefined') {
          console.warn = originalWarn;
        }
        
        hideLoadingScreen();
        addChatMessage('system', `‚ùå Failed to load Janus model: ${error.message}. Falling back to templates.`);
        fallbackToTemplates();
      }
    }

    // Show loading screen
    function showLoadingScreen() {
      const loadingScreen = document.createElement('div');
      loadingScreen.id = 'loadingScreen';
      loadingScreen.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 3000; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
      `;
      
              loadingScreen.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.5); text-align: center;">
          <div style="color: white; font-size: 24px; font-weight: 600; margin-bottom: 20px;">
            üöÄ Loading Qwen2.5-0.5B
          </div>
          <div style="color: rgba(255,255,255,0.8); margin-bottom: 30px;">
            First time download: ~500MB ‚Ä¢ Cached for future use
          </div>
          
          <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 20px; 
                      margin-bottom: 15px; overflow: hidden;">
            <div id="progressBar" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); 
                                        height: 100%; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          
          <div id="progressText" style="color: rgba(255,255,255,0.9); font-size: 14px;">
            Initializing...
          </div>
          <div id="progressPercent" style="color: white; font-size: 18px; font-weight: 600; margin-top: 10px;">
            0%
          </div>
        </div>
      `;
      
      document.body.appendChild(loadingScreen);
    }

    // Update loading progress
    function updateLoadingProgress(percent, message) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      
      // Validate and clamp percentage
      const validPercent = Math.max(0, Math.min(100, Math.round(percent || 0)));
      
      if (progressBar) progressBar.style.width = validPercent + '%';
      if (progressText) progressText.textContent = message || 'Loading...';
      if (progressPercent) progressPercent.textContent = validPercent + '%';
      
      // Log progress for debugging
      console.log(`Loading progress: ${validPercent}% - ${message}`);
    }

    // Hide loading screen
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transform = 'scale(0.9)';
        loadingScreen.style.transition = 'all 0.3s ease';
        setTimeout(() => {
          if (loadingScreen.parentNode) {
            loadingScreen.parentNode.removeChild(loadingScreen);
          }
        }, 300);
      }
    }

    // Fallback to templates
    function fallbackToTemplates() {
      aiSession = 'template';
      document.getElementById('aiStatus').textContent = 'AI: Smart Templates ‚ö°';
      document.getElementById('generateBtn').disabled = false;
      document.getElementById('initAIBtn').textContent = '‚ö° Templates Ready';
      updateStatus('‚ö° Smart Templates ready!');
      addChatMessage('system', '‚ö° Smart Template system activated! Uses pattern matching for instant code generation. Works for: "particle explosion", "rainbow spiral", "ocean waves", "geometric patterns", etc.');
    }

    // Generate code using AI (Janus or Smart Templates)
    async function generateAICode(userPrompt) {
      if (!aiSession) {
        updateStatus('‚ùå AI not connected. Click "Connect AI" first.');
        return;
      }

      try {
        // Add user message to chat
        addChatMessage('user', userPrompt);
        
        // Handle different chat modes
        if (chatMode === 'general') {
          return await handleGeneralChat(userPrompt);
        } else {
          return await handleCreativeChat(userPrompt);
        }
        
      } catch (error) {
        console.error('AI generation error:', error);
        updateStatus('‚ùå AI generation failed: ' + error.message);
        addChatMessage('ai', `Error: ${error.message}. Please try again.`);
      }
    }

    // Handle general chat (no code generation)
    async function handleGeneralChat(userPrompt) {
      updateStatus('ü§ñ AI is thinking...');
      
      let aiResponse = '';
      
      // Template mode (Smart responses)
      if (aiSession === 'template') {
        aiResponse = generateGeneralResponse(userPrompt);
        updateStatus('‚ö° Generated response using smart templates!');
      }
      // Qwen2.5 mode - General conversation
      else if (aiSession.type === 'qwen') {
        try {
          const generalPrompt = `Question: ${userPrompt}

Answer this question with a short, accurate response (1-3 sentences maximum). Be direct and factual.`;

          const messages = [
            { role: 'system', content: 'You are a helpful AI assistant. Answer questions clearly and informatively.' },
            { role: 'user', content: generalPrompt }
          ];
          
          const textInput = aiSession.tokenizer.apply_chat_template(messages, { 
            tokenize: false, 
            add_generation_prompt: true 
          });
          
          const inputs = await aiSession.tokenizer(textInput, {
            return_tensors: 'pt',
            padding: true
          });
          
          const genParams = { 
            input_ids: inputs.input_ids,
            attention_mask: inputs.attention_mask,
            max_new_tokens: 512,
            temperature: 0.7,
            do_sample: true
          };
          
          const out = await aiSession.model.generate(genParams);
          const newTok = out.slice(null, [inputs.input_ids.dims.at(-1), null]);
          aiResponse = aiSession.tokenizer.batch_decode(newTok, { skip_special_tokens: true })[0];
          
          // Clean up the response aggressively
          aiResponse = aiResponse.trim();
          
          // Remove prompt text and common AI artifacts
          aiResponse = aiResponse.replace(new RegExp(`Question: ${userPrompt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'), '');
          aiResponse = aiResponse.replace(/Answer this question with.*?factual\./gi, '');
          aiResponse = aiResponse.replace(/^(Answer:|Response:|Here's|The answer is:?)/gi, '');
          
          // Take only the first coherent sentence or paragraph
          const sentences = aiResponse.split(/[.!?]+/);
          if (sentences.length > 0) {
            // Find the first sentence that makes sense (has reasonable length and content)
            for (let sentence of sentences) {
              sentence = sentence.trim();
              if (sentence.length > 10 && sentence.length < 200 && 
                  !sentence.toLowerCase().includes('in summary') &&
                  !sentence.toLowerCase().includes('let me') &&
                  !sentence.toLowerCase().includes('i should')) {
                aiResponse = sentence + '.';
                break;
              }
            }
          }
          
          // Fallback if response is still too long or confused
          if (aiResponse.length > 300 || aiResponse.toLowerCase().includes('calcuttonia') || 
              aiResponse.toLowerCase().includes('let me') || aiResponse.toLowerCase().includes('in essence')) {
            aiResponse = generateGeneralResponse(userPrompt);
          }
          
          updateStatus('üöÄ Qwen2.5 responded!');
          
        } catch (error) {
          console.error('General chat error:', error);
          aiResponse = generateGeneralResponse(userPrompt);
          updateStatus('‚ö° Generated response using templates (AI error)');
        }
      }
      
      // Add AI response to chat
      addChatMessage('ai', aiResponse);
    }

    // Handle creative chat (code generation)
    async function handleCreativeChat(userPrompt) {
      updateStatus('ü§ñ AI is generating code...');
      
      let code = '';
      let aiResponse = '';
        
        // Template mode (Smart pattern matching)
        if (aiSession === 'template') {
          code = generateTemplateCode(userPrompt);
          aiResponse = `I've generated a creative p5.js pattern for "${userPrompt}" using smart template matching. The code creates an animated visual based on your description.`;
          updateStatus('‚ö° Generated code using smart templates!');
        }
        // Qwen2.5 mode - Pure text-only generation (no vision components)
        else if (aiSession.type === 'qwen') {
          let generationAttempts = 0;
          const maxGenerationAttempts = 3;
          let janusSuccess = false;
          
          // Strategy: Text-only generation (no vision components)
          while (!janusSuccess && generationAttempts < maxGenerationAttempts) {
            try {
              generationAttempts++;
              
              const fullPrompt = `You must copy this EXACT template and only change the fill() and ellipse() lines:

t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.05
  fill(255,100,150)
  ellipse(400+sin(t)*100,300+cos(t)*100,50,50)
}

For "${userPrompt}", modify ONLY the fill() and ellipse() lines. Keep everything else identical.

FORBIDDEN: gradient, while, if, time(), paddle, var, let, const, document, canvas, Math, PI, speed, x, y

ALLOWED ONLY: t, fill, stroke, ellipse, rect, point, sin, cos, for, background, createCanvas

Return the 6 lines above with your modifications.`;

              // Use proper Qwen2.5 chat format
              const messages = [
                { role: 'system', content: 'You are a helpful assistant that generates p5.js code.' },
                { role: 'user', content: fullPrompt }
              ];
              
              // Apply chat template and tokenize
              const textInput = aiSession.tokenizer.apply_chat_template(messages, { 
                tokenize: false, 
                add_generation_prompt: true 
              });
              
              const inputs = await aiSession.tokenizer(textInput, {
                return_tensors: 'pt',
                padding: true
              });
              
              // Try with different generation parameters based on attempt
              let genParams = { 
                input_ids: inputs.input_ids,
                attention_mask: inputs.attention_mask,
                max_new_tokens: 256,
                temperature: 0.7,
                do_sample: true
              };
              
              if (generationAttempts === 2) {
                // Second attempt: More conservative parameters
                genParams.temperature = 0.5;
                genParams.max_new_tokens = 128;
              } else if (generationAttempts === 3) {
                // Third attempt: Very conservative
                genParams.temperature = 0.3;
                genParams.max_new_tokens = 64;
                genParams.do_sample = false;
              }
              
              const out = await aiSession.model.generate(genParams);
              const newTok = out.slice(null, [inputs.input_ids.dims.at(-1), null]);
              const rawCode = aiSession.tokenizer.batch_decode(newTok, { skip_special_tokens: true })[0];
              
              // Show raw AI output in chat for debugging
              console.log('Raw AI Output:', rawCode);
              addChatMessage('system', `üîç Raw AI Output (attempt ${generationAttempts}):`, rawCode);
              
              // Clean up the response thoroughly
              code = rawCode.trim();
              
              // Remove code blocks and explanatory text
              code = code.replace(/```javascript\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```js\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```paddle_live_code\n?/g, '').replace(/```\n?/g, '');
              
              // Remove forbidden patterns that AI keeps generating
              if (code.includes('paddle') || code.includes('while(true)') || code.includes('gradient') || 
                  code.includes('time()') || code.includes('Math.') || code.includes('speed_')) {
                console.warn('AI generated forbidden patterns, forcing template fallback');
                throw new Error('AI generated forbidden patterns (paddle, while, gradient, etc.)');
              }
              
              // ULTRA-AGGRESSIVE EXTRACTION: Force our exact pattern
              // Strategy 1: Look for t=0 followed by draw function
              let codeMatch = code.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
              if (codeMatch) {
                code = codeMatch[1];
              } else {
                // Strategy 2: Look for draw function only and prepend t=0
                codeMatch = code.match(/(draw\s*=\s*[^{]*{[\s\S]*?})/);
                if (codeMatch) {
                  code = 't=0\n' + codeMatch[1];
                } else {
                  // Strategy 3: Look for any p5.js-like function calls
                  codeMatch = code.match(/(createCanvas|background|fill|stroke|ellipse|rect|point)[\s\S]*?}/);
                  if (codeMatch) {
                    // Build a proper p5.js structure around it
                    code = `t=0\ndraw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ${codeMatch[0]}\n}`;
                  } else {
                    // Strategy 4: If nothing works, throw error to trigger template fallback
                    throw new Error('No valid p5.js pattern found in AI response');
                  }
                }
              }
              
              // Remove any remaining HTML/markdown artifacts
              code = code.replace(/<[^>]*>/g, ''); // Remove HTML tags
              code = code.replace(/&[a-zA-Z0-9#]+;/g, ''); // Remove HTML entities
              
              // AGGRESSIVE TEXT REMOVAL: Remove explanatory sentences
              const lines = code.split('\n');
              const codeLines = [];
              let inCodeBlock = false;
              
              for (let line of lines) {
                const trimmed = line.trim();
                
                // Start of code block
                if (trimmed.startsWith('t=') || trimmed.startsWith('draw=')) {
                  inCodeBlock = true;
                }
                
                // Skip explanatory text
                if (!inCodeBlock) continue;
                
                // Skip lines that look like explanations
                if (trimmed && 
                    !trimmed.startsWith('//') &&
                    !trimmed.startsWith('*') &&
                    !trimmed.startsWith('#') &&
                    !trimmed.match(/^\d+\.?\s/) && // Skip numbered lists
                    !trimmed.toLowerCase().includes('this example') &&
                    !trimmed.toLowerCase().includes('to further') &&
                    !trimmed.toLowerCase().includes('note:') &&
                    !trimmed.toLowerCase().includes('represents') &&
                    !trimmed.toLowerCase().includes('defines what') &&
                    !trimmed.toLowerCase().includes('we keep track') &&
                    !trimmed.toLowerCase().includes('assumes all') &&
                    !trimmed.toLowerCase().includes('elaborat') &&
                    !/^(the|this|you|we|i|it|here|above|below)\s+/i.test(trimmed) &&
                    (trimmed.includes('=') || trimmed.includes('{') || trimmed.includes('}') || 
                     trimmed.includes('(') || trimmed.includes('for') || trimmed.includes('if'))) {
                  codeLines.push(line);
                }
                
                // End of code block
                if (trimmed === '}' && inCodeBlock) {
                  break;
                }
              }
              
              code = codeLines.join('\n').trim();
              
              // Final validation: ensure we have proper p5.js structure
              if (!code || code.length < 10) {
                addChatMessage('system', `‚ö†Ô∏è Extracted code too short: "${code}"`);
                throw new Error('No valid JavaScript code extracted from AI response');
              }
              
              // Force proper p5.js format if missing key components
              if (!code.includes('t=0')) {
                code = 't=0\n' + code;
              }
              if (!code.includes('draw=')) {
                code = code.replace(/^/, 'draw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ') + '\n}';
              }
              if (!code.includes('createCanvas')) {
                code = code.replace('draw=_=>{', 'draw=_=>{\n  t||createCanvas(w=800,h=600)');
              }
              
              // Show cleaned code before validation
              console.log('Cleaned Code:', code);
              addChatMessage('system', `üßπ Cleaned Code:`, code);
              
              // Validate code syntax before using
              try {
                new Function(code);
                console.log('‚úÖ Code syntax validation passed');
              } catch (syntaxError) {
                console.error('‚ùå Syntax Error Details:', syntaxError);
                console.error('‚ùå Problematic Code:', code);
                console.warn('Generated code has syntax errors, using template instead');
                
                // Show detailed error info in chat
                addChatMessage('system', `‚ùå Syntax Error: ${syntaxError.message}`);
                addChatMessage('system', `üêõ Problematic Code: "${code.substring(0, 100)}${code.length > 100 ? '...' : ''}"`);
                addChatMessage('system', `üîß Falling back to smart templates...`);
                
                // Don't retry AI, go straight to templates for this request
                code = generateTemplateCode(userPrompt);
                aiResponse = `I've generated a creative p5.js pattern for "${userPrompt}" using smart templates (AI generated invalid syntax: ${syntaxError.message}).`;
                updateStatus('‚ö° Generated code using templates (AI syntax error)');
                janusSuccess = true; // Stop retrying
                break;
              }
              aiResponse = `I've created a custom p5.js animation for "${userPrompt}" using Qwen2.5-0.5B (attempt ${generationAttempts}). Pure text model with no vision components.`;
              updateStatus(`üöÄ Qwen2.5-0.5B generated code (attempt ${generationAttempts})!`);
              janusSuccess = true;
              
            } catch (janusError) {
              console.error(`Janus generation attempt ${generationAttempts} failed:`, janusError);
              
              // If this is the last attempt, provide detailed error feedback
              if (generationAttempts >= maxGenerationAttempts) {
                // Provide specific feedback for different error types
                let errorMessage = janusError.message;
                if (errorMessage.includes('WebGPU') && errorMessage.includes('Unsupported data type')) {
                  errorMessage = 'WebGPU compatibility issue with model data types';
                } else if (errorMessage.includes('ReduceMean')) {
                  errorMessage = 'ONNX runtime execution error';
                } else if (errorMessage.includes('Float16Array')) {
                  errorMessage = 'Browser lacks Float16Array support';
                } else if (errorMessage.includes('float16 tensor')) {
                  errorMessage = 'Float16 data type not supported';
                } else if (errorMessage.includes('out of memory')) {
                  errorMessage = 'Insufficient memory for model execution';
                }
                
                // Final fallback to templates
                addChatMessage('ai', `‚ö†Ô∏è Qwen2.5 failed after ${generationAttempts} attempts: ${errorMessage}. Using smart templates instead...`);
                code = generateTemplateCode(userPrompt);
                aiResponse = `I've generated a creative p5.js pattern for "${userPrompt}" using smart templates (Qwen2.5 had persistent runtime errors).`;
                updateStatus('‚ö° Generated code using templates (Qwen2.5 failed multiple attempts)');
                break;
              } else {
                // Try again with different parameters
                addChatMessage('system', `‚ö†Ô∏è Qwen2.5 attempt ${generationAttempts} failed, trying again with different parameters...`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
              }
            }
          }
        }
        
        if (code.length > 10) {
          editorInstance.setValue(code);
          
          // Execute the code safely
          try {
            window.runSketch(code);
            updateStatus('‚úÖ Code generated and executed successfully!');
          } catch (runError) {
            console.error('Error running generated code:', runError);
            updateStatus('‚ö†Ô∏è Code generated but execution failed. Check the code editor.');
            addChatMessage('ai', `‚ö†Ô∏è Generated code but execution failed: ${runError.message}. You can still edit and run it manually.`);
          }
          
          // Add AI response to chat with code preview
          const codePreview = code.split('\n').slice(0, 3).join('\n') + (code.split('\n').length > 3 ? '\n...' : '');
          addChatMessage('ai', aiResponse, codePreview);
          
        } else {
          addChatMessage('ai', 'Sorry, I couldn\'t generate valid code for that prompt. Could you try describing it differently?');
          updateStatus('‚ùå Generated invalid code. Try a different prompt.');
        }
    }

    // Smart Template System - Pattern-based code generation
    function generateTemplateCode(prompt) {
      const lower = prompt.toLowerCase();
      
      // Particle systems & explosions
      if (lower.includes('particle') || lower.includes('explosion') || lower.includes('dots') || lower.includes('stars')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.02
  for(i=0;i<300;i++){
    x=w/2+sin(t+i*0.1)*i*2
    y=h/2+cos(t+i*0.1)*i*2
    fill(sin(i)*127+128,cos(i)*127+128,255,200)
    ellipse(x,y,5,5)
  }
}`;
      }
      
      // Spirals & galaxies
      if (lower.includes('spiral') || lower.includes('galaxy') || lower.includes('swirl') || lower.includes('twist')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.03
  for(i=0;i<150;i++){
    a=t+i*0.3
    r=i*4
    x=w/2+cos(a)*r
    y=h/2+sin(a)*r
    fill(sin(a)*127+128,cos(a+1)*127+128,255)
    ellipse(x,y,8,8)
  }
}`;
      }
      
      // Waves & ocean
      if (lower.includes('wave') || lower.includes('ocean') || lower.includes('water') || lower.includes('sine')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,50)
  t+=0.1
  for(i=0;i<w;i+=8){
    y=h/2+sin(i*0.02+t)*80
    fill(0,150,255,180)
    ellipse(i,y,12,12)
  }
}`;
      }
      
      // Geometric patterns
      if (lower.includes('geometric') || lower.includes('triangle') || lower.includes('square') || lower.includes('polygon')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,40)
  t+=0.04
  for(i=0;i<10;i++)for(j=0;j<8;j++){
    x=i*80+40
    y=j*75+40
    fill(sin(t+i+j)*127+128,cos(t+i-j)*127+128,255)
    ellipse(x+sin(t)*20,y+cos(t)*20,30,30)
  }
}`;
      }
      
      // Kaleidoscope
      if (lower.includes('kaleidoscope') || lower.includes('mandala') || lower.includes('symmetry')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.05
  for(i=0;i<12;i++){
    a=i*PI/6+t
    x=w/2+cos(a)*200
    y=h/2+sin(a)*200
    fill(sin(a+t)*127+128,cos(a+t)*127+128,255)
    for(j=0;j<5;j++){
      ellipse(x+cos(a+j)*j*10,y+sin(a+j)*j*10,15,15)
    }
  }
}`;
      }
      
      // Colorful/rainbow
      if (lower.includes('colorful') || lower.includes('rainbow') || lower.includes('color')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.06
  for(i=0;i<100;i++){
    x=w/2+sin(t+i*0.2)*i*3
    y=h/2+cos(t+i*0.2)*i*3
    fill(sin(i+t)*127+128,cos(i+t*2)*127+128,sin(i+t*3)*127+128)
    ellipse(x,y,10,10)
  }
}`;
      }
      
      // Default creative pattern
      return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.04
  for(i=0;i<80;i++){
    x=w/2+sin(t+i*0.1)*i*2.5
    y=h/2+cos(t+i*0.15)*i*2.5
    fill(sin(t+i)*127+128,cos(t+i*0.5)*127+128,255)
    ellipse(x,y,8,8)
  }
}`;
    }

    // Generate general responses for template mode
    function generateGeneralResponse(prompt) {
      const lower = prompt.toLowerCase();
      
      // Programming/coding questions
      if (lower.includes('programming') || lower.includes('coding') || lower.includes('javascript') || lower.includes('p5.js')) {
        return "I'd be happy to help with programming questions! For p5.js specifically, try switching to Creative Mode to generate visual code. For general programming concepts, I can explain algorithms, data structures, best practices, and more.";
      }
      
      // AI/ML questions
      if (lower.includes('ai') || lower.includes('machine learning') || lower.includes('neural network') || lower.includes('artificial intelligence')) {
        return "AI and machine learning are fascinating fields! Neural networks are computational models inspired by biological brains, using layers of interconnected nodes to learn patterns from data. They're used in everything from image recognition to natural language processing like this conversation!";
      }
      
      // Technology questions
      if (lower.includes('technology') || lower.includes('computer') || lower.includes('software') || lower.includes('hardware')) {
        return "Technology is constantly evolving! I can discuss various topics like software development, computer hardware, emerging technologies, programming languages, frameworks, and how different systems work together.";
      }
      
      // Creative questions
      if (lower.includes('creative') || lower.includes('art') || lower.includes('design') || lower.includes('visual')) {
        return "Creativity and art are wonderful topics! Digital art, generative design, creative coding, and visual aesthetics all play important roles in modern creative expression. Tools like p5.js make it easy to create interactive art and animations.";
      }
      
      // Science questions
      if (lower.includes('science') || lower.includes('physics') || lower.includes('math') || lower.includes('mathematics')) {
        return "Science and mathematics form the foundation of our understanding of the world! From basic principles to complex theories, these fields help us model reality and solve problems. What specific area interests you?";
      }
      
      // Geography/world knowledge
      if (lower.includes('capital') && lower.includes('india')) {
        return "The capital of India is New Delhi.";
      }
      if (lower.includes('capital') && lower.includes('france')) {
        return "The capital of France is Paris.";
      }
      if (lower.includes('capital') && lower.includes('japan')) {
        return "The capital of Japan is Tokyo.";
      }
      if (lower.includes('capital') && lower.includes('uk') || lower.includes('united kingdom') || lower.includes('england')) {
        return "The capital of the United Kingdom is London.";
      }
      
      // General greeting/help
      if (lower.includes('hello') || lower.includes('hi') || lower.includes('help') || lower.includes('what can you do')) {
        return "Hello! I'm your AI assistant. In General Chat mode, I can discuss various topics like technology, science, programming, art, and more. Switch to Creative Mode if you want to generate p5.js visual art code. What would you like to talk about?";
      }
      
      // Default response
      return `That's an interesting question about "${prompt}"! I can discuss a wide range of topics including technology, science, programming, art, and general knowledge. Feel free to ask me anything specific you'd like to know more about.`;
    }

    function updateStatus(message) {
      document.getElementById('statusBar').textContent = message;
      setTimeout(() => {
        document.getElementById('statusBar').textContent = 'Ready to create amazing p5.js art! üöÄ';
      }, 3000);
    }

    // Chat Functions
    function addChatMessage(type, content, codePreview = null) {
      const chatHistoryEl = document.getElementById('chatHistory');
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${type}`;
      
      let headerText = '';
      switch(type) {
        case 'user': headerText = 'üë§ You'; break;
        case 'ai': 
          if (aiSession === 'template') {
            headerText = 'ü§ñ Smart Templates';
          } else if (aiSession.type === 'qwen') {
            headerText = 'üß† Qwen2.5-0.5B';
          } else {
            headerText = 'ü§ñ AI Assistant';
          }
          break;
        case 'system': headerText = '‚öôÔ∏è System'; break;
      }
      
      messageEl.innerHTML = `
        <div class="message-header">${headerText}</div>
        <div>${content}</div>
        ${codePreview ? `<div class="code-preview">${codePreview}</div>` : ''}
      `;
      
      chatHistoryEl.appendChild(messageEl);
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      
      // Store in history
      chatHistory.push({ type, content, codePreview, timestamp: Date.now() });
    }

    // AI Panel Functions
    function toggleAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleBtn.classList.add('active');
      } else {
        panel.classList.add('hidden');
        toggleBtn.classList.remove('active');
      }
    }

    function minimizeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const content = document.getElementById('aiContent');
      
      if (panel.classList.contains('minimized')) {
        panel.classList.remove('minimized');
        content.classList.remove('minimized');
      } else {
        panel.classList.add('minimized');
        content.classList.add('minimized');
      }
    }

    function closeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      panel.classList.add('hidden');
      toggleBtn.classList.remove('active');
    }

    // Toggle between Creative and General chat modes
    function toggleChatMode() {
      const modeBtn = document.getElementById('chatModeBtn');
      const promptInput = document.getElementById('aiPrompt');
      
      if (chatMode === 'creative') {
        chatMode = 'general';
        modeBtn.textContent = 'üí¨ General Chat';
        modeBtn.style.background = 'linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)';
        promptInput.placeholder = 'Ask me anything... e.g., "Explain how neural networks work" or "What is the weather like?"';
        addChatMessage('system', 'üí¨ Switched to General Chat mode. You can now ask any questions without p5.js code generation.');
      } else {
        chatMode = 'creative';
        modeBtn.textContent = 'üé® Creative Mode';
        modeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        promptInput.placeholder = 'Describe what you want to create... e.g., "colorful spinning triangles" or "particle system with gravity"';
        addChatMessage('system', 'üé® Switched to Creative Coding mode. Describe visual patterns to generate p5.js code.');
      }
    }

    // Editor expand/minimize functions
    function expandEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const canvasContainer = document.querySelector('.canvas-container');
      const expandBtn = document.getElementById('expandEditorBtn');
      
      if (editorContainer.classList.contains('expanded')) {
        // Restore normal view
        editorContainer.classList.remove('expanded');
        canvasContainer.classList.remove('hidden');
        expandBtn.textContent = '‚§¢';
        expandBtn.title = 'Expand Editor';
        updateStatus('üìù Editor restored to normal view');
      } else {
        // Expand editor
        editorContainer.classList.add('expanded');
        canvasContainer.classList.add('hidden');
        expandBtn.textContent = '‚§°';
        expandBtn.title = 'Restore Editor';
        updateStatus('üìù Editor expanded for full-screen coding');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    function minimizeEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const minimizeBtn = document.getElementById('minimizeEditorBtn');
      
      if (editorContainer.classList.contains('minimized')) {
        // Restore editor
        editorContainer.classList.remove('minimized');
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize Editor';
        updateStatus('üìù Editor restored');
      } else {
        // Minimize editor
        editorContainer.classList.add('minimized');
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Restore Editor';
        updateStatus('üìù Editor minimized');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    // Runner: execute user code in p5 context (Global scope)
    window.runSketch = function(src) {
      if (currentP5) currentP5.remove();

      try {
        updateStatus('üé® Running your code...');
        
        // Create p5 instance and execute the user's code
        currentP5 = new p5((p) => {
          
          // Make p5 functions available in global scope for user code
          const p5Functions = ['createCanvas', 'background', 'stroke', 'point', 'sin', 'cos', 'mag', 'noise', 'noFill', 'arc', 'fill', 'noStroke', 'strokeWeight', 'ellipse', 'rect', 'line', 'triangle', 'quad', 'bezier', 'curve', 'random'];
          
          p5Functions.forEach(fn => {
            if (p[fn]) {
              window[fn] = p[fn].bind(p);
            }
          });
          
          // Constants
          window.PI = p.PI;
          window.TWO_PI = p.TWO_PI;
          window.HALF_PI = p.HALF_PI;
          window.PIE = p.PIE;
          window.CHORD = p.CHORD;
          window.OPEN = p.OPEN;
          
          // Common variables
          window.w = 400;
          window.W = 720;
          
          try {
            // Execute user code directly
            eval(src);
            
            // If draw function was created globally, use it
            if (window.draw && typeof window.draw === 'function') {
              p.draw = window.draw;
              updateStatus('‚úÖ Code executed successfully!');
            }
            
          } catch (evalError) {
            console.error('Error executing user code:', evalError);
            updateStatus('‚ùå Code error: ' + evalError.message);
            // Fallback to a simple sketch
            p.setup = function() {
              p.createCanvas(400, 400);
              p.background(50);
            };
            p.draw = function() {
              p.stroke(255);
              p.text('Code Error: Check Console', 10, 20);
            };
          }
          
        }, 'canvas');
        
      } catch (error) {
        console.error('Error running sketch:', error);
        updateStatus('‚ùå Failed to run sketch');
      }
    };

    require(['vs/editor/editor.main'], () => {
      // Initialize Monaco with default fish code
      editorInstance = monaco.editor.create(
        document.getElementById('editor'), {
          value: [
            '// Welcome to SketchPad-SLM!',
            '// Edit this code and click "Draw" to see magic happen ‚ú®',
            '',
            '// Fish animation scaled to full canvas size',
            'a=(x,y,d=mag(k=(4+cos(y))*cos(x/4),e=y/8-20))=>point((q=sin(k*3)+sin(y/19+9)*k*(6+sin(e*14-d)))*cos(d/8+t/4)+50*cos(c=d-t)+w/2,q*sin(c)+d*7*sin(c/4)+h/2)',
            't=0,draw=$=>{if(!t){w=800;h=600;createCanvas(w,h)}background(9);stroke(255,116);for(t+=PI/120,i=1e4;i--;)a(i,i/235)}'
          ].join('\n'),
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 14,
          minimap: { enabled: false },
          scrollBeyondLastLine: false,
          wordWrap: 'on'
      });

      // Load design from lib/Designs folder
      async function loadDesign(designName) {
        if (!designName) return;
        
        try {
          updateStatus(`üìÅ Loading ${designName}...`);
          const response = await fetch(designs[designName]);
          if (response.ok) {
            const code = await response.text();
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`‚úÖ Loaded ${designName} successfully!`);
          } else {
            updateStatus(`‚ùå Failed to load ${designName}`);
          }
        } catch (error) {
          console.error('Error loading design:', error);
          updateStatus(`‚ùå Error loading ${designName}`);
        }
      }

      // Event Listeners
      document.getElementById('runBtn').addEventListener('click', () => {
        window.runSketch(editorInstance.getValue());
      });

      document.getElementById('designSelect').addEventListener('change', (e) => {
        loadDesign(e.target.value);
      });

      document.getElementById('loadFileBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.name.endsWith('.js')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const code = e.target.result;
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`‚úÖ Loaded ${file.name}`);
          };
          reader.readAsText(file);
        } else {
          updateStatus('‚ùå Please select a .js file');
        }
      });

      document.getElementById('saveFileBtn').addEventListener('click', () => {
        const code = editorInstance.getValue();
        const blob = new Blob([code], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sketch_${Date.now()}.js`;
        a.click();
        URL.revokeObjectURL(url);
        updateStatus('üíæ File saved successfully!');
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (currentP5) {
          currentP5.remove();
          currentP5 = null;
          updateStatus('üóëÔ∏è Canvas cleared');
        }
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        editorInstance.setValue([
          '// Welcome to SketchPad-SLM!',
          '// Edit this code and click "Draw" to see magic happen ‚ú®',
          '',
          't=0',
          'draw=_=>{',
          '  t||createCanvas(400,400)',
          '  background(0)',
          '  t+=0.05',
          '  ',
          '  // Your creative code here!',
          '  fill(sin(t)*127+128,cos(t)*127+128,255)',
          '  ellipse(200+sin(t)*100,200+cos(t)*100,50,50)',
          '}'
        ].join('\n'));
        updateStatus('üîÑ Code reset to template');
      });

      // AI Event Listeners
      document.getElementById('initAIBtn').addEventListener('click', initializeAI);
      document.getElementById('chatModeBtn').addEventListener('click', toggleChatMode);
      
      document.getElementById('generateBtn').addEventListener('click', () => {
        const prompt = document.getElementById('aiPrompt').value.trim();
        if (prompt) {
          generateAICode(prompt);
        } else {
          updateStatus('‚ùå Please enter a prompt first');
        }
      });

      // Allow Enter key in prompt textarea to generate
      document.getElementById('aiPrompt').addEventListener('keydown', (e) => {
        // Enter (without Shift) generates code
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault(); // Prevent new line
          const prompt = e.target.value.trim();
          if (prompt && !document.getElementById('generateBtn').disabled) {
            generateAICode(prompt);
            // Clear the input after generating
            setTimeout(() => {
              e.target.value = '';
            }, 100);
          }
        }
        // Shift+Enter allows new lines for multi-line prompts
      });

      // AI Panel event listeners
      document.getElementById('aiToggleBtn').addEventListener('click', toggleAIPanel);
      document.getElementById('minimizeBtn').addEventListener('click', minimizeAIPanel);
      document.getElementById('closeBtn').addEventListener('click', closeAIPanel);

      // Editor control event listeners
      document.getElementById('expandEditorBtn').addEventListener('click', expandEditor);
      document.getElementById('minimizeEditorBtn').addEventListener('click', minimizeEditor);

      // Auto-run fish animation on load
      setTimeout(() => {
        window.runSketch(editorInstance.getValue());
      }, 1000);

      updateStatus('üöÄ SketchPad-SLM loaded successfully!');
    });
  </script>
</body>
</html>

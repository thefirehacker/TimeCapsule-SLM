## AI Flow Attachment Integrity – Analysis & Scope

### Background
AI Flow sessions can ingest learning plans generated by the local SWE bridge as well as by FlowFrameGenerator. Each frame may include a supporting resource (PDF, KB excerpt, text note, video). These attachments must:
- Survive the entire pipeline (generator → ingestion → graph view → exports)
- Carry accurate metadata (original source, KB document ID, type, URL)
- Render correctly in both the canvas graph and the dual-pane frame viewer

### Primary Pain Points Observed
1. **Missing/invalid attachment URLs**  
   Generator output often omits `url`, so ingestion discarded the attachments. Graph nodes and exports ended up empty.
2. **Session contamination & orphan nodes**  
   Attachment nodes were keyed solely by the KB filename. When multiple frames referenced the same KB PDF, React saw duplicate keys and either collapsed or duplicated nodes, leaving “Unknown attachment” placeholders.
3. **KB metadata lost in transit**  
   Imports treated KB PDFs as plain URLs (`pdfSource: "url"`). The UI therefore labeled them as generic “PDF” attachments, and regression exports could not distinguish Knowledge Base assets from web links.
4. **UI title/context mismatches**  
   Some generator responses stored summaries in `title`, causing the dual-pane header to display context text instead of the real frame title. This compounded user confusion when attachments were also mislabeled.

### Fixes Already Staged
- **Generator-side URL inference** (`FlowFrameGeneratorAgent`): Added `ensureAttachmentUrl` to backfill missing URLs/IDs from RAG chunks or KB documents, guaranteeing each attachment has a resolvable pointer plus `originalSourceId`.
- **Attachment canonicalization** (`useAIFlowBuilder`):  
  - Extract URLs from descriptions / `originalSourceId`.  
  - Detect KB PDFs and set `pdfSource: "knowledge_base"` + `kbDocumentId`.  
  - Normalize titles/information text so the dual-pane header uses actual frame titles.
- **Graph synchronization improvements** (`EnhancedLearningGraph`, `EnhancedAIFrameNode`, `DualPaneFrameView`):  
  - Derive fallback frame titles from Markdown headings.  
  - Auto-create/refresh attachment nodes per frame with KB metadata, preventing duplicate React keys.  
  - Display “Knowledge Base: <title>” badges when `pdfSource === "knowledge_base"`.

### Remaining Work (current plan)
1. **Unique per-frame attachment IDs** – ensure every attachment instance gets a frame-scoped ID while still referencing the shared KB doc via `kbDocumentId`.
2. **UI labeling polish** – update all attachment summaries (graph, dual-pane, export helpers) to show “KB Document” when appropriate.
3. **Legacy import normalization** – when bridging older JSON (e.g., `Delete/28Nov_2...`), map `type: "document"/"code"` attachments into the canonical `pdf-kb` form so `pdfSource` is stored correctly.
4. **Regression test** – re-import the fleet JSON, confirm no duplicate-key warnings, verify every frame shows the KB badge, and inspect saved graph state/exports.

### Core Objective
Deliver a resilient attachment pipeline so any AI-generated plan (SWE bridge or Flow builder) automatically:
- Preserves Knowledge Base provenance
- Renders consistent labels across graph + dual-pane
- Avoids orphaned/duplicate attachment nodes
- Keeps exports/printouts aligned with the on-canvas truth

